<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PLKWCC Motor EV Race System (Cloud DB)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Chivo+Mono:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
        
        .digital-display { font-family: 'Chivo Mono', monospace; letter-spacing: -2px; }
        .title-font { font-family: 'Orbitron', sans-serif; }
        
        body {
            background-color: #050505;
            background-image: url('https://images.unsplash.com/photo-1596484552993-868c78c772be?q=80&w=2670&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            overflow-x: hidden;
            touch-action: manipulation;
        }
        .bg-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); z-index: -1; pointer-events: none;
        }
        .checkered-strip {
            height: 24px; width: 100%;
            background-image: linear-gradient(45deg, #000 25%, transparent 25%), linear-gradient(-45deg, #000 25%, transparent 25%);
            background-size: 20px 20px; background-color: #e5e7eb; border-bottom: 2px solid #ef4444;
        }
        .running-glow { color: #ef4444; text-shadow: 0 0 15px rgba(239, 68, 68, 0.8); }
        .stopped-glow { color: #d1d5db; text-shadow: 0 0 8px rgba(209, 213, 219, 0.4); }
        .light { background-color: #1f2937; box-shadow: inset 0 0 10px #000; }
        .light-red { background-color: #ef4444; box-shadow: 0 0 30px #ef4444, inset 0 0 5px #fff; }
        .light-green { background-color: #22c55e; box-shadow: 0 0 30px #22c55e, inset 0 0 5px #fff; }
        .menu-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .judge-btn:active { transform: scale(0.95); }
    </style>
</head>
<body class="text-white min-h-screen flex flex-col p-4">

    <div class="bg-overlay"></div>

    <div id="homePage" class="flex-grow flex flex-col items-center justify-center w-full max-w-7xl mx-auto">
        <div class="text-center mb-16">
            <h1 class="title-font text-5xl md:text-7xl font-black text-white mb-2 drop-shadow-lg">PLKWCC</h1>
            <h2 class="title-font text-2xl md:text-4xl font-bold text-red-500 uppercase">Motor EV Race</h2>
            <p class="mt-4 text-gray-400 font-mono text-sm tracking-widest border-t border-gray-800 inline-block pt-2 px-8">CLOUD DATABASE SYSTEM</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-3xl px-6">
            <button onclick="window.navigateTo('racePage')" class="menu-btn group relative overflow-hidden rounded-2xl bg-gradient-to-br from-gray-900 to-black border border-gray-700 p-8 text-center transition-all duration-300 hover:border-red-600">
                <i class="fa-solid fa-flag-checkered text-5xl text-red-500 mb-4"></i>
                <h3 class="title-font text-2xl font-bold text-white mb-2">ENTER RACE</h3>
            </button>
            <button onclick="window.navigateTo('adminPage')" class="menu-btn group relative overflow-hidden rounded-2xl bg-gradient-to-br from-gray-900 to-black border border-gray-700 p-8 text-center transition-all duration-300 hover:border-blue-600">
                <i class="fa-solid fa-gear text-5xl text-blue-500 mb-4"></i>
                <h3 class="title-font text-2xl font-bold text-white mb-2">SETTINGS</h3>
            </button>
        </div>
    </div>

    <div id="racePage" class="hidden flex-grow w-full max-w-7xl mx-auto items-center justify-center flex-col">
        <div class="w-full mb-4 flex justify-start">
            <button onclick="window.navigateTo('homePage')" class="flex items-center space-x-2 text-gray-400 hover:text-white bg-black/50 px-4 py-2 rounded-lg border border-gray-700">
                <i class="fa-solid fa-arrow-left"></i><span>HOME</span>
            </button>
        </div>

        <div class="w-full bg-gray-900/90 backdrop-blur-md rounded-2xl shadow-2xl overflow-hidden border-4 border-red-600 relative min-h-[800px] flex flex-col">
            <div class="checkered-strip flex-shrink-0"></div>
            <div class="p-6 md:p-10 pt-8 flex-grow flex flex-col">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-10 items-stretch flex-grow">
                    <div class="flex flex-col h-full justify-center">
                        <div class="flex justify-center items-center gap-3 mb-8 p-4 bg-black rounded-lg border-2 border-gray-700 shadow-2xl mx-auto">
                            <div class="light w-10 h-10 md:w-14 md:h-14 rounded-full border-4 border-gray-600" id="light1"></div>
                            <div class="light w-10 h-10 md:w-14 md:h-14 rounded-full border-4 border-gray-600" id="light2"></div>
                            <div class="light w-10 h-10 md:w-14 md:h-14 rounded-full border-4 border-gray-600" id="light3"></div>
                            <div class="light w-10 h-10 md:w-14 md:h-14 rounded-full border-4 border-gray-600" id="light4"></div>
                            <div class="light w-10 h-10 md:w-14 md:h-14 rounded-full border-4 border-gray-600" id="light5"></div>
                        </div>

                        <div class="flex flex-col gap-10">
                            <div class="relative">
                                <div id="display" class="digital-display text-5xl md:text-6xl lg:text-7xl text-center font-bold p-6 bg-black/50 rounded-lg border-2 border-red-700 stopped-glow">00:00.000</div>
                            </div>
                            <div class="space-y-4">
                                <button id="mainButton" class="w-full px-4 py-5 text-xl font-bold rounded-xl bg-green-600 hover:bg-green-700 text-white shadow-lg border-b-4 border-green-800" onclick="window.handleMainButton()">START RACE</button>
                                <div class="flex space-x-4">
                                    <button id="lapButton1" class="flex-1 px-4 py-5 text-lg font-bold rounded-xl bg-blue-600 hover:bg-blue-700 text-white border-b-4 border-blue-800" onclick="window.lapResetStopwatch(1)" disabled>
                                        <span class="text-sm opacity-75 mb-1 block">DRIVER 1</span><span class="btn-text">LAP</span>
                                    </button>
                                    <button id="lapButton2" class="flex-1 px-4 py-5 text-lg font-bold rounded-xl bg-orange-600 hover:bg-orange-700 text-white border-b-4 border-orange-800" onclick="window.lapResetStopwatch(2)" disabled>
                                        <span class="text-sm opacity-75 mb-1 block">DRIVER 2</span><span class="btn-text">LAP</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col h-full lg:border-l lg:border-gray-700 lg:pl-10 relative">
                        <h2 class="text-xl font-semibold text-red-400 border-b border-red-700 pb-1">CURRENT RACE</h2>
                        <div class="grid grid-cols-2 gap-4 h-[200px] shrink-0 mt-4">
                            <div class="flex flex-col bg-gray-900/50 rounded-lg p-2 border border-gray-700 h-full">
                                <input type="text" id="driverName1" value="HAM" class="bg-blue-900/20 text-blue-400 font-bold text-center w-full mb-2" placeholder="DRIVER 1">
                                <div id="lapTimes1" class="lap-list flex-1 overflow-y-auto bg-black/40 p-2 rounded relative text-xs"></div>
                            </div>
                            <div class="flex flex-col bg-gray-900/50 rounded-lg p-2 border border-gray-700 h-full">
                                <input type="text" id="driverName2" value="RUS" class="bg-orange-900/20 text-orange-400 font-bold text-center w-full mb-2" placeholder="DRIVER 2">
                                <div id="lapTimes2" class="lap-list flex-1 overflow-y-auto bg-black/40 p-2 rounded relative text-xs"></div>
                            </div>
                        </div>
                        <div class="relative flex-1 flex flex-col mt-6 min-h-0">
                            <h2 class="text-xl font-semibold mb-3 text-yellow-400 border-b border-yellow-700 pb-1">
                                LEADERBOARD <span class="text-[10px] text-gray-500 font-normal ml-2">TOP 7</span>
                            </h2>
                            <div id="leaderboardList" class="bg-black/60 p-3 rounded-lg border border-gray-700 flex-1 overflow-y-auto custom-scrollbar"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="adminPage" class="hidden flex-grow flex flex-col items-center justify-center w-full max-w-7xl mx-auto">
        <div class="w-full mb-4 flex justify-start">
            <button onclick="window.navigateTo('homePage')" class="flex items-center space-x-2 text-gray-400 hover:text-white bg-black/50 px-4 py-2 rounded-lg border border-gray-700">
                <i class="fa-solid fa-arrow-left"></i><span>HOME</span>
            </button>
        </div>
        <div class="w-full max-w-2xl bg-gray-900/90 rounded-2xl border border-gray-700 overflow-hidden">
            <div class="bg-gray-800 p-4 border-b border-gray-700"><h2 class="text-xl font-bold text-white">ADMIN PANEL</h2></div>
            <div class="p-8 space-y-8">
                <div class="bg-black/40 p-5 rounded-lg border border-gray-700 text-center">
                    <h4 class="text-white font-bold text-lg mb-2">JUDGE / MARSHAL INTERFACE</h4>
                    <button onclick="window.navigateTo('judgePage')" class="w-full bg-purple-900/50 hover:bg-purple-600 text-purple-200 border border-purple-800 py-3 rounded-xl font-bold">OPEN JUDGE CONTROLLER</button>
                </div>
                <div class="flex items-center justify-between bg-black/40 p-4 rounded-lg border border-gray-700">
                    <div><h4 class="text-white font-bold">Clear Leaderboard</h4><p class="text-gray-500 text-xs">Delete all Cloud Records.</p></div>
                    <button onclick="window.resetLeaderboard()" class="bg-red-900/50 hover:bg-red-600 text-red-200 border border-red-800 px-4 py-2 rounded font-bold text-sm">RESET DATA</button>
                </div>
            </div>
        </div>
    </div>

    <div id="judgePage" class="hidden flex-grow flex-col w-full h-full absolute top-0 left-0 bg-black z-50">
        <div class="bg-gray-900 border-b border-gray-800 p-4 flex justify-between items-center">
            <div class="flex items-center space-x-2"><div id="dbStatus" class="w-3 h-3 rounded-full bg-red-500"></div><span class="text-gray-300 font-mono text-sm">LIVE</span></div>
            <button onclick="window.navigateTo('adminPage')" class="text-gray-500 border border-gray-700 px-3 py-1 rounded">EXIT</button>
        </div>
        <div class="flex-grow flex flex-col p-4 space-y-6 justify-center">
            <h2 class="text-center text-gray-400 text-sm font-bold tracking-widest uppercase">Tap when car crosses line</h2>
            <button onclick="window.judgeTrigger(1)" class="judge-btn flex-1 bg-blue-600 rounded-3xl flex flex-col items-center justify-center border-4 border-blue-800">
                <span class="text-4xl font-black italic">CAR 1</span><span class="text-blue-200 text-lg">TAP TO LAP</span>
            </button>
            <button onclick="window.judgeTrigger(2)" class="judge-btn flex-1 bg-orange-600 rounded-3xl flex flex-col items-center justify-center border-4 border-orange-800">
                <span class="text-4xl font-black italic">CAR 2</span><span class="text-orange-200 text-lg">TAP TO LAP</span>
            </button>
        </div>
    </div>

    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onChildAdded, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // ==============================================================
        // ⚠️ 設定步驟：
        // 1. 去 https://console.firebase.google.com/ 建立一個專案
        // 2. 建立 Realtime Database (選 Test Mode)
        // 3. 在 Project Settings -> General -> Your Apps 複製 Config
        // ==============================================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyAW8E7aoH6d0Z3tGICt7eDKHC_140fXtj8",
            authDomain: "plkwcc-race.firebaseapp.com",
            databaseURL: "https://plkwcc-race-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "plkwcc-race",
            storageBucket: "plkwcc-race.firebasestorage.app",
            messagingSenderId: "150051218678",
            appId: "1:150051218678:web:fb9bbe82682da4f924f8d7"
            // --- 在這裡貼上你的 FIREBASE CONFIG ---
            // 例如:
            // apiKey: "AIzaSy...",
            // authDomain: "project.firebaseapp.com",
            // databaseURL: "https://project-default-rtdb.firebaseio.com",
            // projectId: "project",
            // storageBucket: "project.appspot.com",
            // messagingSenderId: "123...",
            // appId: "1:123..."
        };

        // Initialize Firebase
        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            console.log("Firebase Connected");
        } catch(e) {
            console.error("Firebase Config Missing! Please add your config in the code.");
            alert("Error: Firebase Config missing. Check code.");
        }

        // --- GLOBAL VARIABLES ---
        let synth = null;
        let audioInitialized = false;
        let startTime = 0;
        let totalElapsedTimeMs = 0;
        let timerInterval = null;
        let isRunning = false;
        let isStartingSequence = false;
        let lightTimeouts = []; 

        const lights = [
            document.getElementById('light1'), document.getElementById('light2'),
            document.getElementById('light3'), document.getElementById('light4'), document.getElementById('light5')
        ];

        const d1 = { id: 1, lapCounter: 0, previousTotalTimeMs: 0, lapHistory: [], fastestLap: Infinity, container: document.getElementById('lapTimes1'), input: document.getElementById('driverName1') };
        const d2 = { id: 2, lapCounter: 0, previousTotalTimeMs: 0, lapHistory: [], fastestLap: Infinity, container: document.getElementById('lapTimes2'), input: document.getElementById('driverName2') };

        // --- FIREBASE LISTENERS ---
        
        // 1. Listen for Judge Triggers (Action Queue)
        if(db) {
            const actionsRef = ref(db, 'actions');
            onChildAdded(actionsRef, (snapshot) => {
                const action = snapshot.val();
                // Only process if added in the last 2 seconds (avoid processing old actions on reload)
                const now = Date.now();
                if (now - action.timestamp < 5000) { 
                    if (action.type === 'trigger_lap') {
                        // Visual feedback on Judge Page
                        if (!document.getElementById('judgePage').classList.contains('hidden')) {
                            // Judge saw it sent
                        }
                        // Action on Big Screen
                        if (!document.getElementById('racePage').classList.contains('hidden') && isRunning) {
                            window.recordLap(action.driverId);
                            // Flash overlay
                            const overlay = document.querySelector('.bg-overlay');
                            overlay.style.backgroundColor = 'rgba(255,255,255,0.2)';
                            setTimeout(() => overlay.style.backgroundColor = 'rgba(0,0,0,0.85)', 100);
                        }
                    }
                }
            });

            // 2. Listen for Leaderboard Changes
            const lbRef = ref(db, 'leaderboard');
            onValue(lbRef, (snapshot) => {
                const data = snapshot.val();
                const leaderboard = data ? Object.values(data) : [];
                // Sort
                leaderboard.sort((a, b) => a.time - b.time);
                // Render Top 7
                renderLeaderboardHTML(leaderboard.slice(0, 7));
            });
            
            // Connection Status Indicator for Judge
            const connectedRef = ref(db, '.info/connected');
            onValue(connectedRef, (snap) => {
                const statusEl = document.getElementById('dbStatus');
                if (snap.val() === true) {
                    statusEl.classList.remove('bg-red-500');
                    statusEl.classList.add('bg-green-500', 'animate-pulse');
                } else {
                    statusEl.classList.add('bg-red-500');
                    statusEl.classList.remove('bg-green-500', 'animate-pulse');
                }
            });
        }

        // --- EXPOSE FUNCTIONS TO WINDOW (Because type="module" is scoped) ---
        
        window.initAudio = async function() {
            if (typeof Tone !== 'undefined') {
                if (!audioInitialized) {
                    synth = new Tone.PolySynth(Tone.Synth).toDestination();
                    synth.volume.value = -5;
                    audioInitialized = true;
                }
                if (Tone.context.state !== 'running') await Tone.start();
            }
        }

        window.navigateTo = function(pageId) {
            window.initAudio();
            ['homePage', 'racePage', 'adminPage', 'judgePage'].forEach(id => {
                const el = document.getElementById(id);
                el.classList.add('hidden');
                el.classList.remove('flex');
            });
            const target = document.getElementById(pageId);
            target.classList.remove('hidden');
            target.classList.add('flex');
            if(synth) synth.triggerAttackRelease("C5", "0.05");
        }

        window.judgeTrigger = function(driverId) {
            if (navigator.vibrate) navigator.vibrate(50);
            if(db) {
                // Push to Firebase
                push(ref(db, 'actions'), {
                    type: 'trigger_lap',
                    driverId: driverId,
                    timestamp: Date.now()
                });
            } else {
                alert("Database not connected. Check config.");
            }
        }

        window.resetLeaderboard = function() {
            if(confirm("Delete ALL Cloud Records?")) {
                if(db) set(ref(db, 'leaderboard'), null);
            }
        }

        window.handleMainButton = function() {
            window.initAudio();
            if (isStartingSequence) { abortSequence(); return; }
            if (isRunning) { stopStopwatch(); } else { startLightSequence(); }
        }

        window.lapResetStopwatch = function(driverId) {
            if (isRunning) window.recordLap(driverId);
            else fullReset();
        }

        window.recordLap = function(driverId) {
            const driver = driverId === 1 ? d1 : d2;
            driver.lapCounter++;
            const totalTimeMs = totalElapsedTimeMs;
            const lapDurationMs = totalTimeMs - driver.previousTotalTimeMs;
            
            let diff = 0;
            if (driver.lapCounter > 1) {
                diff = lapDurationMs - driver.lapHistory[driver.lapHistory.length - 1].lapDurationMs;
            }

            let isFastest = false;
            if (lapDurationMs < driver.fastestLap) {
                driver.fastestLap = lapDurationMs;
                isFastest = true;
            }

            // Save to Firebase Leaderboard
            if(db) {
                push(ref(db, 'leaderboard'), {
                    name: driver.input.value || "UNK",
                    time: lapDurationMs,
                    date: new Date().toISOString()
                });
            }

            driver.lapHistory.push({ lap: driver.lapCounter, lapDurationMs: lapDurationMs, diff: diff });
            driver.previousTotalTimeMs = totalTimeMs;
            
            playLapSound(diff);
            renderDriverLapList(driver, isFastest);
        }

        // --- INTERNAL LOGIC ---

        function renderLeaderboardHTML(leaderboard) {
            const container = document.getElementById('leaderboardList');
            if (leaderboard.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-xs text-center py-20">No records.</p>';
                return;
            }
            let html = '<div class="space-y-1">';
            leaderboard.forEach((entry, index) => {
                const rank = index + 1;
                let color = rank === 1 ? 'text-yellow-400' : (rank === 2 ? 'text-gray-300' : (rank === 3 ? 'text-orange-400' : 'text-gray-400'));
                html += `<div class="flex justify-between text-sm py-2 border-b border-gray-800">
                    <div class="flex space-x-3"><span class="${color} font-bold w-6 text-center">${rank}</span><span class="text-white font-mono font-bold">${entry.name}</span></div>
                    <span class="digital-display text-white">${formatTime(entry.time)}</span>
                </div>`;
            });
            container.innerHTML = html + '</div>';
        }

        function renderDriverLapList(driver, isFastest) {
            const lap = driver.lapHistory[driver.lapHistory.length - 1];
            const el = document.createElement('div');
            let classes = 'flex justify-between py-1 px-2 mb-1 rounded text-xs ';
            classes += isFastest ? 'bg-yellow-900/60 text-yellow-300 font-bold' : 'bg-gray-800/80 text-gray-300';
            
            let diffHtml = '<span class="w-12"></span>';
            if (lap.lap > 1) {
                const color = lap.diff < 0 ? 'text-green-400' : 'text-red-400';
                const sign = lap.diff < 0 ? '-' : '+';
                diffHtml = `<span class="${color} digital-display ml-2 w-12 text-right">${sign}${formatTimeMs(lap.diff)}</span>`;
            }
            
            el.className = classes;
            el.innerHTML = `<span class="font-bold w-8">L${lap.lap}</span><span class="flex-1 text-center">${formatTime(lap.lapDurationMs)}</span>${diffHtml}`;
            if (driver.container.firstChild) driver.container.insertBefore(el, driver.container.firstChild);
            else driver.container.appendChild(el);
        }

        function playLapSound(diff) {
            if (synth) synth.triggerAttackRelease(diff < 0 ? "G4" : "C4", "0.1");
        }

        function formatTime(time) {
            const ms = String(Math.floor((time % 1000))).padStart(3, '0');
            const sec = String(Math.floor(time / 1000) % 60).padStart(2, '0');
            const min = String(Math.floor(time / 60000)).padStart(2, '0');
            return `${min}:${sec}.${ms}`;
        }
        function formatTimeMs(time) {
            time = Math.abs(time);
            return `${Math.floor(time/1000)}.${String(time%1000).padStart(3,'0')}`;
        }

        function startLightSequence() {
            resetTimerStateOnly();
            isStartingSequence = true;
            lights.forEach(l => l.className = "light w-10 h-10 md:w-14 md:h-14 rounded-full border-4 border-gray-600");
            document.querySelector('#mainButton span').innerText = "ABORT";
            document.getElementById('mainButton').className = "w-full px-4 py-5 text-xl font-bold rounded-xl bg-yellow-600 text-white border-b-4 border-yellow-800";
            
            for(let i=0; i<5; i++) {
                lightTimeouts.push(setTimeout(() => {
                    lights[i].classList.add('light-red');
                    if(synth) synth.triggerAttackRelease("G3", "0.1");
                }, 1000 * (i+1)));
            }
            lightTimeouts.push(setTimeout(lightsOutAndGo, 6000));
        }

        function lightsOutAndGo() {
            isStartingSequence = false;
            lights.forEach(l => { l.classList.remove('light-red'); l.classList.add('light-green'); });
            if(synth) synth.triggerAttackRelease(["C4","E4","G4"], "0.5");
            isRunning = true;
            startTime = Date.now();
            
            const animate = () => {
                if(isRunning) {
                    totalElapsedTimeMs = Date.now() - startTime;
                    document.getElementById('display').innerText = formatTime(totalElapsedTimeMs);
                    timerInterval = requestAnimationFrame(animate);
                }
            };
            timerInterval = requestAnimationFrame(animate);
            
            const display = document.getElementById('display');
            display.classList.replace('stopped-glow', 'running-glow');
            const btn = document.getElementById('mainButton');
            btn.className = "w-full px-4 py-5 text-xl font-bold rounded-xl bg-red-600 hover:bg-red-700 text-white border-b-4 border-red-800";
            btn.querySelector('span').innerText = "STOP SESSION";
            
            document.getElementById('lapButton1').disabled = false;
            document.getElementById('lapButton2').disabled = false;
            setTimeout(() => lights.forEach(l => l.classList.remove('light-green')), 1000);
        }

        function stopStopwatch() {
            if(synth) { const now = Tone.now(); synth.triggerAttackRelease("C4","0.1",now); synth.triggerAttackRelease("G3","0.3",now+0.15); }
            isRunning = false;
            cancelAnimationFrame(timerInterval);
            document.getElementById('display').classList.replace('running-glow', 'stopped-glow');
            const btn = document.getElementById('mainButton');
            btn.className = "w-full px-4 py-5 text-xl font-bold rounded-xl bg-green-600 hover:bg-green-700 text-white border-b-4 border-green-800";
            btn.querySelector('span').innerText = "START RACE";
            document.querySelectorAll('.btn-text').forEach(el => el.innerText = "RESET");
        }

        function resetTimerStateOnly() {
            totalElapsedTimeMs = 0;
            document.getElementById('display').innerText = '00:00.000';
            d1.lapCounter = 0; d1.previousTotalTimeMs = 0; d1.lapHistory = []; d1.fastestLap = Infinity; d1.container.innerHTML = '';
            d2.lapCounter = 0; d2.previousTotalTimeMs = 0; d2.lapHistory = []; d2.fastestLap = Infinity; d2.container.innerHTML = '';
            document.querySelectorAll('.btn-text').forEach(el => el.innerText = "LAP");
        }
        
        function abortSequence() {
            isStartingSequence = false;
            lightTimeouts.forEach(clearTimeout);
            lightTimeouts = [];
            lights.forEach(l => l.className = "light w-10 h-10 md:w-14 md:h-14 rounded-full border-4 border-gray-600");
            const btn = document.getElementById('mainButton');
            btn.className = "w-full px-4 py-5 text-xl font-bold rounded-xl bg-green-600 text-white border-b-4 border-green-800";
            btn.querySelector('span').innerText = "START RACE";
        }
        
        function fullReset() {
            stopStopwatch();
            resetTimerStateOnly();
            document.getElementById('lapButton1').disabled = true;
            document.getElementById('lapButton2').disabled = true;
        }

    </script>
</body>
</html>
