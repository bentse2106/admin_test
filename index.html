<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PLKWCC Motor EV Race System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Chivo+Mono:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
        
        .digital-display {
            font-family: 'Chivo Mono', monospace;
            letter-spacing: -2px;
            transition: text-shadow 0.3s ease-in-out, color 0.3s ease-in-out;
        }

        .title-font {
            font-family: 'Orbitron', sans-serif;
        }

        body {
            background-color: #050505;
            position: relative;
            background-image: url('https://images.unsplash.com/photo-1596484552993-868c78c772be?q=80&w=2670&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            overflow-x: hidden;
            touch-action: manipulation; /* Improves touch response on mobile */
        }

        .bg-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            background-image: 
                linear-gradient(45deg, rgba(20,20,20,0.5) 25%, transparent 25%, transparent 75%, rgba(20,20,20,0.5) 75%, rgba(20,20,20,0.5)),
                linear-gradient(45deg, rgba(20,20,20,0.5) 25%, transparent 25%, transparent 75%, rgba(20,20,20,0.5) 75%, rgba(20,20,20,0.5));
            background-size: 4px 4px;
            z-index: -1;
            pointer-events: none;
        }

        /* Checkered Flag Pattern */
        .checkered-strip {
            height: 24px;
            width: 100%;
            background-image: 
                linear-gradient(45deg, #000 25%, transparent 25%), 
                linear-gradient(-45deg, #000 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #000 75%), 
                linear-gradient(-45deg, transparent 75%, #000 75%);
            background-size: 20px 20px;
            background-color: #e5e7eb;
            border-bottom: 2px solid #ef4444;
        }

        /* Glow Effects */
        .running-glow {
            color: #ef4444;
            text-shadow: 0 0 8px rgba(239, 68, 68, 0.8), 0 0 15px rgba(239, 68, 68, 0.5);
        }

        .stopped-glow {
            color: #d1d5db;
            text-shadow: 0 0 8px rgba(209, 213, 219, 0.7), 0 0 15px rgba(209, 213, 219, 0.4);
        }

        /* Scrollbar */
        .lap-list::-webkit-scrollbar, .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .lap-list::-webkit-scrollbar-thumb, .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #ef4444;
            border-radius: 3px;
        }
        .lap-list::-webkit-scrollbar-track, .custom-scrollbar::-webkit-scrollbar-track {
            background: #1f2937;
        }

        /* Lights */
        .light {
            background-color: #1f2937;
            box-shadow: inset 0 0 10px #000;
        }
        .light-red {
            background-color: #ef4444;
            box-shadow: 0 0 15px #ef4444, 0 0 30px #ef4444, inset 0 0 5px #fff;
            border-color: #fca5a5;
        }
        .light-green {
            background-color: #22c55e;
            box-shadow: 0 0 15px #22c55e, 0 0 30px #22c55e, inset 0 0 5px #fff;
            border-color: #86efac;
        }

        .menu-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5), 0 8px 10px -6px rgba(0, 0, 0, 0.5);
        }

        /* Judge Button Styles */
        .judge-btn {
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
        }
        .judge-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body class="text-white min-h-screen flex flex-col p-4">

    <div class="bg-overlay"></div>

    <div id="homePage" class="flex-grow flex flex-col items-center justify-center w-full max-w-7xl mx-auto">
        
        <div class="text-center mb-16 animate-fade-in-down">
            <div class="flex justify-center mb-6">
                <img src="https://upload.wikimedia.org/wikipedia/commons/3/33/F1.svg" alt="F1 Logo" class="h-20 md:h-24 w-auto drop-shadow-[0_0_15px_rgba(255,0,0,0.5)]">
            </div>
            <h1 class="title-font text-5xl md:text-7xl font-black text-white mb-2 tracking-wider drop-shadow-lg">
                PLKWCC
            </h1>
            <h2 class="title-font text-2xl md:text-4xl font-bold text-red-500 tracking-[0.2em] uppercase">
                Motor EV Race
            </h2>
            <p class="mt-4 text-gray-400 font-mono text-sm tracking-widest border-t border-gray-800 inline-block pt-2 px-8">
                OFFICIAL TIMING SYSTEM
            </p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full max-w-3xl px-6">
            <button onclick="navigateTo('racePage')" class="menu-btn group relative overflow-hidden rounded-2xl bg-gradient-to-br from-gray-900 to-black border border-gray-700 p-8 text-center transition-all duration-300 hover:border-red-600">
                <div class="absolute inset-0 bg-red-600/10 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                <div class="relative z-10 flex flex-col items-center">
                    <i class="fa-solid fa-flag-checkered text-5xl text-red-500 mb-4 group-hover:scale-110 transition-transform duration-300"></i>
                    <h3 class="title-font text-2xl font-bold text-white mb-2">ENTER RACE</h3>
                    <p class="text-gray-500 text-sm">Start Timing & Telemetry</p>
                </div>
            </button>

            <button onclick="navigateTo('adminPage')" class="menu-btn group relative overflow-hidden rounded-2xl bg-gradient-to-br from-gray-900 to-black border border-gray-700 p-8 text-center transition-all duration-300 hover:border-blue-600">
                <div class="absolute inset-0 bg-blue-600/10 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                <div class="relative z-10 flex flex-col items-center">
                    <i class="fa-solid fa-gear text-5xl text-blue-500 mb-4 group-hover:rotate-90 transition-transform duration-500"></i>
                    <h3 class="title-font text-2xl font-bold text-white mb-2">SETTINGS</h3>
                    <p class="text-gray-500 text-sm">Admin Panel & Data</p>
                </div>
            </button>
        </div>
        <div class="mt-20 text-gray-600 text-xs">System Ready • v2.3 (Sync Enabled)</div>
    </div>


    <div id="racePage" class="hidden flex-grow w-full max-w-7xl mx-auto items-center justify-center flex-col">
        <div class="w-full mb-4 flex justify-start">
            <button onclick="navigateTo('homePage')" class="flex items-center space-x-2 text-gray-400 hover:text-white transition-colors bg-black/50 px-4 py-2 rounded-lg border border-gray-700 hover:border-gray-500 backdrop-blur-sm">
                <i class="fa-solid fa-arrow-left"></i>
                <span class="font-bold text-sm tracking-widest">HOME</span>
            </button>
        </div>

        <div class="w-full bg-gray-900/90 backdrop-blur-md rounded-2xl shadow-2xl overflow-hidden border-4 border-red-600 transition duration-300 hover:shadow-red-700/70 relative min-h-[800px] flex flex-col">
            <div class="checkered-strip flex-shrink-0"></div>
            <div class="p-6 md:p-10 pt-8 flex-grow flex flex-col">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-10 items-stretch flex-grow">
                    
                    <div class="flex flex-col h-full justify-center">
                        <div class="flex flex-col items-center mb-8">
                            <div class="flex items-center space-x-3 mb-2">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/3/33/F1.svg" alt="F1 Logo" class="h-12 md:h-16 w-auto">
                            </div>
                            <h1 class="text-3xl font-bold text-center text-red-500 uppercase tracking-widest leading-none">
                                PLKWCC<br>
                                <span class="text-white text-base md:text-xl tracking-[0.1em] block mt-1">Motor Electric Vehicle Race</span>
                            </h1>
                        </div>

                        <div class="flex justify-center items-center gap-3 mb-8 p-4 bg-black rounded-lg border-2 border-gray-700 shadow-2xl mx-auto">
                            <div class="light w-10 h-10 md:w-14 md:h-14 rounded-full border-4 border-gray-600 transition-all duration-75" id="light1"></div>
                            <div class="light w-10 h-10 md:w-14 md:h-14 rounded-full border-4 border-gray-600 transition-all duration-75" id="light2"></div>
                            <div class="light w-10 h-10 md:w-14 md:h-14 rounded-full border-4 border-gray-600 transition-all duration-75" id="light3"></div>
                            <div class="light w-10 h-10 md:w-14 md:h-14 rounded-full border-4 border-gray-600 transition-all duration-75" id="light4"></div>
                            <div class="light w-10 h-10 md:w-14 md:h-14 rounded-full border-4 border-gray-600 transition-all duration-75" id="light5"></div>
                        </div>

                        <div class="flex flex-col gap-10">
                            <div class="relative">
                                <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-gray-800 px-2 text-xs text-gray-500 uppercase tracking-widest border border-gray-700 rounded">Session Time</div>
                                <div id="display" class="digital-display text-5xl md:text-6xl lg:text-7xl text-center font-bold p-6 bg-black/50 rounded-lg border-2 border-red-700 select-none stopped-glow">00:00.000</div>
                            </div>

                            <div class="space-y-4">
                                <button id="mainButton" class="w-full px-4 py-5 text-xl font-bold rounded-xl transition duration-200 bg-green-600 hover:bg-green-700 text-white shadow-lg shadow-green-700/50 active:scale-95 disabled:opacity-50 flex items-center justify-center space-x-2 border-b-4 border-green-800" onclick="handleMainButton()">
                                    <span>START RACE</span>
                                </button>
                                
                                <div class="flex space-x-4">
                                    <button id="lapButton1" class="flex-1 px-4 py-5 text-lg font-bold rounded-xl transition duration-200 bg-blue-600 hover:bg-blue-700 text-white shadow-lg shadow-blue-700/50 active:scale-95 disabled:opacity-50 flex flex-col items-center justify-center border-b-4 border-blue-800 leading-none" onclick="lapResetStopwatch(1)" disabled>
                                        <span class="text-sm opacity-75 mb-1">DRIVER 1</span>
                                        <span class="btn-text">LAP</span>
                                    </button>
                                    <button id="lapButton2" class="flex-1 px-4 py-5 text-lg font-bold rounded-xl transition duration-200 bg-orange-600 hover:bg-orange-700 text-white shadow-lg shadow-orange-700/50 active:scale-95 disabled:opacity-50 flex flex-col items-center justify-center border-b-4 border-orange-800 leading-none" onclick="lapResetStopwatch(2)" disabled>
                                        <span class="text-sm opacity-75 mb-1">DRIVER 2</span>
                                        <span class="btn-text">LAP</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col h-full lg:border-l lg:border-gray-700 lg:pl-10 relative">
                        <h2 class="text-xl font-semibold text-red-400 border-b border-red-700 pb-1 flex justify-between items-end mt-0">
                            <span>CURRENT RACE</span>
                            <span class="text-xs text-gray-500 font-normal">REAL-TIME</span>
                        </h2>

                        <div class="grid grid-cols-2 gap-4 h-[200px] shrink-0 mt-4">
                            <div class="flex flex-col bg-gray-900/50 rounded-lg p-2 border border-gray-700 h-full">
                                <div class="mb-2 shrink-0">
                                    <input type="text" id="driverName1" value="HAM" maxlength="20" class="bg-blue-900/20 text-blue-400 font-mono font-bold text-center w-full px-2 py-1 rounded border border-blue-900/50 focus:border-blue-500 focus:outline-none uppercase text-lg" placeholder="DRIVER 1">
                                </div>
                                <div id="lapTimes1" class="lap-list flex-1 overflow-y-auto bg-black/40 p-2 rounded border border-gray-800 relative z-10">
                                    <p id="noLapsMessage1" class="text-gray-600 text-xs text-center py-10">Ready</p>
                                </div>
                            </div>
                            <div class="flex flex-col bg-gray-900/50 rounded-lg p-2 border border-gray-700 h-full">
                                <div class="mb-2 shrink-0">
                                    <input type="text" id="driverName2" value="RUS" maxlength="20" class="bg-orange-900/20 text-orange-400 font-mono font-bold text-center w-full px-2 py-1 rounded border border-orange-900/50 focus:border-orange-500 focus:outline-none uppercase text-lg" placeholder="DRIVER 2">
                                </div>
                                <div id="lapTimes2" class="lap-list flex-1 overflow-y-auto bg-black/40 p-2 rounded border border-gray-800 relative z-10">
                                    <p id="noLapsMessage2" class="text-gray-600 text-xs text-center py-10">Ready</p>
                                </div>
                            </div>
                        </div>

                        <div class="relative flex-1 flex flex-col mt-6 min-h-0">
                            <h2 class="text-xl font-semibold mb-3 text-yellow-400 border-b border-yellow-700 pb-1 flex justify-between items-end shrink-0">
                                <span>LEADERBOARD</span>
                                <span class="text-[10px] text-gray-500 font-normal uppercase tracking-wider">Top 7 Records</span>
                            </h2>
                            <div id="leaderboardList" class="bg-black/60 p-3 rounded-lg border border-gray-700 flex-1 overflow-y-auto custom-scrollbar">
                                <p class="text-gray-500 text-xs text-center py-20">No records set yet.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="adminPage" class="hidden flex-grow flex flex-col items-center justify-center w-full max-w-7xl mx-auto">
        <div class="w-full mb-4 flex justify-start">
            <button onclick="navigateTo('homePage')" class="flex items-center space-x-2 text-gray-400 hover:text-white transition-colors bg-black/50 px-4 py-2 rounded-lg border border-gray-700 hover:border-gray-500 backdrop-blur-sm">
                <i class="fa-solid fa-arrow-left"></i>
                <span class="font-bold text-sm tracking-widest">HOME</span>
            </button>
        </div>

        <div class="w-full max-w-2xl bg-gray-900/90 backdrop-blur-md rounded-2xl shadow-2xl border border-gray-700 overflow-hidden">
            <div class="bg-gray-800 p-4 border-b border-gray-700 flex items-center space-x-3">
                <i class="fa-solid fa-gear text-blue-500"></i>
                <h2 class="text-xl font-bold text-white tracking-wider">ADMINISTRATION PANEL</h2>
            </div>
            
            <div class="p-8 space-y-8">
                <div>
                    <h3 class="text-gray-400 text-sm font-bold uppercase tracking-widest mb-4 border-b border-gray-700 pb-2">Race Control</h3>
                    <div class="bg-black/40 p-5 rounded-lg border border-gray-700 flex flex-col items-center text-center">
                        <i class="fa-solid fa-mobile-screen-button text-3xl text-purple-500 mb-3"></i>
                        <h4 class="text-white font-bold text-lg">Marshal / Judge Interface</h4>
                        <p class="text-gray-500 text-sm mb-4">Open this page on the device located at the finish line.</p>
                        <button onclick="navigateTo('judgePage')" class="w-full bg-purple-900/50 hover:bg-purple-600 text-purple-200 border border-purple-800 hover:border-purple-500 px-4 py-3 rounded-xl transition font-bold flex items-center justify-center space-x-2">
                            <span>OPEN JUDGE CONTROLLER</span>
                            <i class="fa-solid fa-arrow-right"></i>
                        </button>
                        <p class="text-xs text-gray-600 mt-2">*Requires opening in a separate tab on the same PC for sync to work without a backend server.</p>
                    </div>
                </div>

                <div>
                    <h3 class="text-gray-400 text-sm font-bold uppercase tracking-widest mb-4 border-b border-gray-700 pb-2">Data Management</h3>
                    <div class="flex items-center justify-between bg-black/40 p-4 rounded-lg border border-gray-700">
                        <div>
                            <h4 class="text-white font-bold">Clear Leaderboard</h4>
                            <p class="text-gray-500 text-xs mt-1">Permanently delete all Top 7 records.</p>
                        </div>
                        <button onclick="resetLeaderboard()" class="bg-red-900/50 hover:bg-red-600 text-red-200 border border-red-800 hover:border-red-500 px-4 py-2 rounded transition font-bold text-sm flex items-center space-x-2">
                            <i class="fa-solid fa-trash"></i>
                            <span>RESET DATA</span>
                        </button>
                    </div>
                </div>
            </div>
            <div class="bg-gray-800/50 p-4 border-t border-gray-700 text-center">
                <p class="text-gray-600 text-xs">Protected Area. Authorized Personnel Only.</p>
            </div>
        </div>
    </div>

    <div id="judgePage" class="hidden flex-grow flex-col w-full h-full absolute top-0 left-0 bg-black z-50">
        <div class="bg-gray-900 border-b border-gray-800 p-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <div class="w-3 h-3 rounded-full bg-green-500 animate-pulse"></div>
                <span class="text-gray-300 font-mono text-sm">CONNECTED</span>
            </div>
            <button onclick="navigateTo('adminPage')" class="text-gray-500 hover:text-white px-3 py-1 border border-gray-700 rounded">
                EXIT
            </button>
        </div>

        <div class="flex-grow flex flex-col p-4 space-y-6 justify-center">
            <h2 class="text-center text-gray-400 text-sm font-bold tracking-widest uppercase">Tap when car crosses line</h2>
            
            <button id="judgeBtn1" onclick="judgeTrigger(1)" class="judge-btn flex-1 bg-blue-600 active:bg-blue-400 rounded-3xl flex flex-col items-center justify-center shadow-lg shadow-blue-900/50 border-4 border-blue-800 transition-all">
                <span class="text-4xl font-black italic">CAR 1</span>
                <span class="text-blue-200 text-lg mt-1">TAP TO LAP</span>
            </button>

            <button id="judgeBtn2" onclick="judgeTrigger(2)" class="judge-btn flex-1 bg-orange-600 active:bg-orange-400 rounded-3xl flex flex-col items-center justify-center shadow-lg shadow-orange-900/50 border-4 border-orange-800 transition-all">
                <span class="text-4xl font-black italic">CAR 2</span>
                <span class="text-orange-200 text-lg mt-1">TAP TO LAP</span>
            </button>
        </div>

        <div class="p-4 bg-gray-900 border-t border-gray-800 text-center text-xs text-gray-600">
            MARSHAL CONTROL • LATENCY: <10ms
        </div>
    </div>

    <script>
        // --- SYNC LOGIC (BroadcastChannel) ---
        // This allows two tabs on the same browser to talk to each other
        const raceChannel = new BroadcastChannel('race_sync_channel');

        raceChannel.onmessage = (event) => {
            const { action, data } = event.data;
            if (action === 'trigger_lap') {
                // If running on the "Big Screen", execute the lap
                if (isRunning && !document.getElementById('racePage').classList.contains('hidden')) {
                    recordLap(data.driverId);
                    // Visual feedback on Big Screen that signal received
                    flashScreen();
                }
            }
        };

        function flashScreen() {
            const overlay = document.querySelector('.bg-overlay');
            overlay.style.backgroundColor = 'rgba(255,255,255,0.1)';
            setTimeout(() => {
                overlay.style.backgroundColor = 'rgba(0,0,0,0.85)';
            }, 100);
        }

        // --- Navigation Logic ---
        function navigateTo(pageId) {
            initAudio();

            // Hide all pages
            document.getElementById('homePage').classList.add('hidden');
            document.getElementById('racePage').classList.add('hidden');
            document.getElementById('adminPage').classList.add('hidden');
            document.getElementById('judgePage').classList.add('hidden');
            
            // Remove flex
            document.getElementById('homePage').classList.remove('flex');
            document.getElementById('racePage').classList.remove('flex');
            document.getElementById('adminPage').classList.remove('flex');
            document.getElementById('judgePage').classList.remove('flex');

            // Show selected page
            const target = document.getElementById(pageId);
            target.classList.remove('hidden');
            target.classList.add('flex');
            
            if(synth) synth.triggerAttackRelease("C5", "0.05");
        }

        // --- Judge Logic ---
        function judgeTrigger(driverId) {
            // Haptic feedback for mobile
            if (navigator.vibrate) navigator.vibrate(50);
            
            // 1. Send signal to other tabs (Big Screen)
            raceChannel.postMessage({
                action: 'trigger_lap',
                data: { driverId: driverId }
            });

            // 2. Also try to trigger locally (in case Judge Page is open on the same tab just to test)
            // But we only want to record if the timer is actually running in logic
            // In a pure "Judge" view, we assume the logic is running elsewhere, 
            // but for simple testing:
            if (isRunning) {
                recordLap(driverId);
            }
        }

        // --- Existing Race Logic ---

        const display = document.getElementById('display');
        const mainButton = document.getElementById('mainButton');
        const lapButton1 = document.getElementById('lapButton1');
        const lapButton2 = document.getElementById('lapButton2');
        
        const lapTimesContainer1 = document.getElementById('lapTimes1');
        const lapTimesContainer2 = document.getElementById('lapTimes2');
        const noLapsMessage1 = document.getElementById('noLapsMessage1');
        const noLapsMessage2 = document.getElementById('noLapsMessage2');
        
        const driverInput1 = document.getElementById('driverName1');
        const driverInput2 = document.getElementById('driverName2');
        const leaderboardContainer = document.getElementById('leaderboardList');
        
        const lights = [
            document.getElementById('light1'),
            document.getElementById('light2'),
            document.getElementById('light3'),
            document.getElementById('light4'),
            document.getElementById('light5')
        ];

        let synth = null;
        let audioInitialized = false;

        let startTime = 0;
        let totalElapsedTimeMs = 0;
        let timerInterval = null;
        let isRunning = false;
        let isStartingSequence = false;
        let lightTimeouts = []; 
        
        const d1 = {
            id: 1, lapCounter: 0, previousTotalTimeMs: 0, lapHistory: [], fastestLap: Infinity,
            container: lapTimesContainer1, noLapsMsg: noLapsMessage1, input: driverInput1
        };

        const d2 = {
            id: 2, lapCounter: 0, previousTotalTimeMs: 0, lapHistory: [], fastestLap: Infinity,
            container: lapTimesContainer2, noLapsMsg: noLapsMessage2, input: driverInput2
        };

        const LEADERBOARD_KEY = 'f1_leaderboard_v2'; 
        let leaderboard = [];

        loadLeaderboard();
        renderLeaderboard();

        [driverInput1, driverInput2].forEach(input => {
            input.addEventListener('input', (e) => {
                e.target.value = e.target.value.toUpperCase();
            });
        });

        async function initAudio() {
            if (typeof Tone !== 'undefined') {
                if (!audioInitialized) {
                    synth = new Tone.PolySynth(Tone.Synth).toDestination();
                    synth.volume.value = -5;
                    audioInitialized = true;
                }
                if (Tone.context.state !== 'running') {
                    await Tone.start();
                }
            }
        }

        function playLightSound(type) {
            if (synth) {
                if (type === 'red') synth.triggerAttackRelease("G3", "0.1");
                else if (type === 'go') synth.triggerAttackRelease(["C4", "E4", "G4"], "0.5");
            }
        }

        function playLapSound(diff) {
            if (synth) {
                if (diff < 0) synth.triggerAttackRelease("G4", "0.1");
                else synth.triggerAttackRelease("C4", "0.1");
            }
        }

        function playEndSound() {
            if (synth) {
                const now = Tone.now();
                synth.triggerAttackRelease("C4", "0.1", now);
                synth.triggerAttackRelease("G3", "0.3", now + 0.15);
            }
        }

        function formatTime(time) {
            time = Math.max(0, time);
            const milliseconds = String(Math.floor((time % 1000))).padStart(3, '0');
            const totalSeconds = Math.floor(time / 1000);
            const seconds = String(totalSeconds % 60).padStart(2, '0');
            const minutes = String(Math.floor(totalSeconds / 60)).padStart(2, '0');
            return `${minutes}:${seconds}.${milliseconds}`;
        }
        
        function formatTimeMs(time) {
            time = Math.abs(time);
            const totalSeconds = Math.floor(time / 1000);
            const milliseconds = String(Math.floor((time % 1000))).padStart(3, '0');
            return `${totalSeconds}.${milliseconds}`;
        }

        function updateDisplay() {
            if (isRunning) {
                totalElapsedTimeMs = Date.now() - startTime;
            }
            display.textContent = formatTime(totalElapsedTimeMs);
        }

        function loadLeaderboard() {
            const stored = localStorage.getItem(LEADERBOARD_KEY);
            if (stored) {
                try {
                    leaderboard = JSON.parse(stored);
                } catch (e) {
                    console.error("Failed to parse leaderboard", e);
                    leaderboard = [];
                }
            }
        }

        function saveToLeaderboard(timeMs, driverName) {
            const driver = driverName || "UNK";
            leaderboard.push({ name: driver, time: timeMs, date: new Date().toISOString() });
            leaderboard.sort((a, b) => a.time - b.time);
            leaderboard = leaderboard.slice(0, 7); // UPDATED: Keep top 7
            localStorage.setItem(LEADERBOARD_KEY, JSON.stringify(leaderboard));
            renderLeaderboard();
        }

        function renderLeaderboard() {
            if (leaderboard.length === 0) {
                leaderboardContainer.innerHTML = '<p class="text-gray-500 text-xs text-center py-20">No records set yet.</p>';
                return;
            }
            let html = '<div class="space-y-1">';
            leaderboard.forEach((entry, index) => {
                const rank = index + 1;
                let rankColor = 'text-gray-400';
                if (rank === 1) rankColor = 'text-yellow-400';
                else if (rank === 2) rankColor = 'text-gray-300';
                else if (rank === 3) rankColor = 'text-orange-400';

                html += `
                    <div class="flex items-center justify-between text-sm py-2 border-b border-gray-800 last:border-0">
                        <div class="flex items-center space-x-3">
                            <span class="${rankColor} font-bold w-6 text-center text-lg digital-display">${rank}</span>
                            <span class="text-white font-mono font-bold bg-gray-800 px-2 py-0.5 rounded tracking-wide border border-gray-700 truncate max-w-[100px]">${entry.name}</span>
                        </div>
                        <span class="digital-display text-white text-lg">${formatTime(entry.time)}</span>
                    </div>
                `;
            });
            html += '</div>';
            leaderboardContainer.innerHTML = html;
        }

        function resetLeaderboard() {
            if(confirm("⚠ WARNING: You are about to delete the Leaderboard data. \n\nAre you sure?")) {
                leaderboard = [];
                localStorage.removeItem(LEADERBOARD_KEY);
                renderLeaderboard();
                alert("Leaderboard reset successfully.");
            }
        }

        function handleMainButton() {
            initAudio();
            if (isStartingSequence) { abortSequence(); return; }
            if (isRunning) { stopStopwatch(); } else { startLightSequence(); }
        }

        function startLightSequence() {
            resetTimerStateOnly();
            isStartingSequence = true;
            lights.forEach(l => { l.classList.remove('light-red'); l.classList.remove('light-green'); });
            mainButton.querySelector('span').innerText = "ABORT START";
            mainButton.classList.replace('bg-green-600', 'bg-yellow-600');
            mainButton.classList.replace('border-green-800', 'border-yellow-800');
            mainButton.classList.replace('shadow-green-700/50', 'shadow-yellow-700/50');
            lapButton1.disabled = true; lapButton2.disabled = true;

            for (let i = 0; i < 5; i++) {
                let t = setTimeout(() => { lights[i].classList.add('light-red'); playLightSound('red'); }, 1000 * (i + 1));
                lightTimeouts.push(t);
            }
            let startT = setTimeout(() => { lightsOutAndGo(); }, 6000);
            lightTimeouts.push(startT);
        }

        function abortSequence() {
            isStartingSequence = false;
            lightTimeouts.forEach(t => clearTimeout(t));
            lightTimeouts = [];
            lights.forEach(l => { l.classList.remove('light-red'); l.classList.remove('light-green'); });
            mainButton.querySelector('span').innerText = "START RACE";
            mainButton.classList.replace('bg-yellow-600', 'bg-green-600');
            mainButton.classList.replace('border-yellow-800', 'border-green-800');
            mainButton.classList.replace('shadow-yellow-700/50', 'shadow-green-700/50');
        }

        function lightsOutAndGo() {
            isStartingSequence = false;
            lights.forEach(l => { l.classList.remove('light-red'); l.classList.add('light-green'); });
            playLightSound('go');
            isRunning = true;
            startTime = Date.now();
            const animate = () => { updateDisplay(); if (isRunning) { timerInterval = requestAnimationFrame(animate); } };
            timerInterval = requestAnimationFrame(animate);
            display.classList.remove('stopped-glow');
            display.classList.add('running-glow');
            mainButton.querySelector('span').innerText = "STOP SESSION";
            mainButton.classList.replace('bg-yellow-600', 'bg-red-600');
            mainButton.classList.replace('border-yellow-800', 'border-red-800');
            mainButton.classList.replace('shadow-yellow-700/50', 'shadow-red-700/50');
            lapButton1.disabled = false; lapButton2.disabled = false;
            lapButton1.querySelector('.btn-text').innerText = "LAP";
            lapButton2.querySelector('.btn-text').innerText = "LAP";
            setTimeout(() => { if (isRunning) { lights.forEach(l => l.classList.remove('light-green')); } }, 1000);
        }

        function stopStopwatch() {
            playEndSound();
            isRunning = false;
            cancelAnimationFrame(timerInterval);
            timerInterval = null;
            lights.forEach(l => l.classList.remove('light-green'));
            display.classList.remove('running-glow');
            display.classList.add('stopped-glow');
            mainButton.querySelector('span').innerText = "START RACE";
            mainButton.classList.replace('bg-red-600', 'bg-green-600');
            mainButton.classList.replace('border-red-800', 'border-green-800');
            mainButton.classList.replace('shadow-red-700/50', 'shadow-green-700/50');
            lapButton1.querySelector('.btn-text').innerText = "RESET";
            lapButton2.querySelector('.btn-text').innerText = "RESET";
            lapButton1.disabled = false; lapButton2.disabled = false;
        }

        function lapResetStopwatch(driverId) {
            if (isRunning) { recordLap(driverId); } else { fullReset(); }
        }
        
        function recordLap(driverId) {
            const driver = driverId === 1 ? d1 : d2;
            driver.lapCounter++;
            const totalTimeMs = totalElapsedTimeMs;
            const lapDurationMs = totalTimeMs - driver.previousTotalTimeMs;
            let diffFromPreviousMs = 0;
            if (driver.lapCounter > 1) {
                const previousLapDurationMs = driver.lapHistory[driver.lapHistory.length - 1].lapDurationMs;
                diffFromPreviousMs = lapDurationMs - previousLapDurationMs;
            }
            let isFastest = false;
            if (lapDurationMs < driver.fastestLap) {
                driver.fastestLap = lapDurationMs;
                isFastest = true;
            }
            saveToLeaderboard(lapDurationMs, driver.input.value);
            driver.lapHistory.push({ lap: driver.lapCounter, totalTimeMs: totalTimeMs, lapDurationMs: lapDurationMs, diffFromPreviousMs: diffFromPreviousMs });
            driver.previousTotalTimeMs = totalTimeMs;
            playLapSound(diffFromPreviousMs);
            renderDriverLapList(driver, isFastest);
        }

        function renderDriverLapList(driver, newLapIsFastest) {
            if (driver.lapCounter === 1) { driver.container.innerHTML = ''; }
            const lap = driver.lapHistory[driver.lapHistory.length - 1];
            const lapElement = document.createElement('div');
            let lapClasses = 'flex justify-between items-center py-1 px-2 mb-1 rounded transition duration-150 backdrop-blur-sm text-xs ';
            if (newLapIsFastest) { lapClasses += 'bg-yellow-900/60 border border-yellow-500/50 text-yellow-300 font-bold'; } 
            else { lapClasses += 'bg-gray-800/80 border border-gray-700 text-gray-300 hover:bg-gray-700/90'; }
            const lapDurationDisplay = formatTime(lap.lapDurationMs);
            let diffHtml = '';
            if (lap.lap > 1) {
                const diff = lap.diffFromPreviousMs;
                let diffText, diffColor;
                if (diff < 0) { diffText = `-${formatTimeMs(Math.abs(diff))}`; diffColor = 'text-green-400'; } 
                else if (diff > 0) { diffText = `+${formatTimeMs(diff)}`; diffColor = 'text-red-400'; } 
                else { diffText = '±0.000'; diffColor = 'text-gray-400'; }
                diffHtml = `<span class="${diffColor} digital-display ml-2 w-12 text-right">${diffText}</span>`;
            } else { diffHtml = `<span class="w-12"></span>`; }
            lapElement.className = lapClasses;
            lapElement.innerHTML = `<span class="font-bold w-8">L${lap.lap}</span><span class="digital-display flex-1 text-center text-sm">${lapDurationDisplay}</span>${diffHtml}`;
            if (driver.container.firstChild) { driver.container.insertBefore(lapElement, driver.container.firstChild); } 
            else { driver.container.appendChild(lapElement); }
        }

        function resetTimerStateOnly() {
            totalElapsedTimeMs = 0;
            display.textContent = '00:00.000';
            d1.lapCounter = 0; d1.previousTotalTimeMs = 0; d1.lapHistory = []; d1.fastestLap = Infinity; d1.container.innerHTML = '<p class="text-gray-600 text-xs text-center py-10">Ready</p>';
            d2.lapCounter = 0; d2.previousTotalTimeMs = 0; d2.lapHistory = []; d2.fastestLap = Infinity; d2.container.innerHTML = '<p class="text-gray-600 text-xs text-center py-10">Ready</p>';
        }

        function fullReset() {
            if (timerInterval) { cancelAnimationFrame(timerInterval); timerInterval = null; }
            isRunning = false;
            resetTimerStateOnly();
            lights.forEach(l => { l.classList.remove('light-red'); l.classList.remove('light-green'); });
            lapButton1.disabled = true; lapButton2.disabled = true;
            lapButton1.querySelector('.btn-text').innerText = "LAP";
            lapButton2.querySelector('.btn-text').innerText = "LAP";
            mainButton.querySelector('span').innerText = "START RACE"; 
            display.classList.remove('running-glow');
            display.classList.add('stopped-glow');
        }
    </script>
</body>
</html>
